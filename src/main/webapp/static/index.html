<!DOCTYPE html>
<html>
<head>
    <title>Hello Chat Room</title>
    <script src="jquery-2.1.0.js"></script>
    <script type="text/javascript">
    	var currentRoomId;
    	var currentRoomName;
    	var currentRoomLastMessageId;
    	
    	function joinRoom(roomId, roomName){
    		currentRoomId = roomId;
    		currentRoomName = roomName;
    		currentRoomLastMessageId = -1;
    		$('#current-room-name').text(currentRoomName);
    		//window.setInterval(fetchMessages(), 100);
    		setInterval(function(){fetchMessages()},100);
    	}
    	
    	/* function startInterval(){
    		window.setInterval(fuction(){
    			fetchMessages();
    		},100);
    	} */
    	
    	function fetchMessages(){
    		var roomURI = "rooms/" + currentRoomId;;
    		var getting = $.get( roomURI, { messageId: currentRoomLastMessageId} );
  		  	getting.done(function( data ) {
  			  	//alert(JSON.stringify(data));
  				var messages = JSON.parse(JSON.stringify(data));
  			  	//alert(messages[0].messageContent);
  			  	for(i = 0 ; i < messages.length; i++){
  			  		$('#current-room-messages').append("<p>" + messages[i].messageContent +"</p>");
  			  		if(messages[i].messageId > currentRoomLastMessageId){
  			  			currentRoomLastMessageId = messages[i].messageId;
  			  		}
  			  	}
  		  	});
    	}
    	
    	function addRoom(){
    		var roomName = $('#add-room-name').val();
    		var posting = $.post( "rooms/add", { name: roomName} );
    		  posting.done(function( data ) {
    		    
    			//alert(JSON.stringify(data));
    			  //Join room after adding
    		    var room = JSON.parse(JSON.stringify(data));
    		    joinRoom(room.roomId, room.name);
    		    
    		  });
    	}
    	
    	function sendMessage(){
    		//var roomId = $('#send-room-id').val();
    		//var userId = $('#send-user-id').val();
    		var roomId = currentRoomId;
    		var userId = 1; //dummy
    		var messageContent = $('#send-message-content').val();
    		var roomURI = "rooms/" + roomId;
    		//alert(roomURI);
    		var posting = $.post( roomURI , { userId: userId, messageContent: messageContent} );
    		  posting.done(function( data ) {
    		    //alert(JSON.stringify(data));
    		  });
    	}
    	
    	function tryJoinRoom(){
    		var roomId = $('#join-room-id').val();
    		var roomName = "unknown";
    		joinRoom(roomId, roomName);
    	}
    </script>
</head>
<body>
<noscript><h2 style="color: #ff0000">Seems like you need to have JavaScript enabled!</h2></noscript>
<div>
    <div id="room-adding-div">
        <button id="add-room" onclick="addRoom();">Add Room</button>
        Name: <input id="add-room-name" type="text" />
    </div>
    <div id="room-joining-div">
        <button id="join-room" onclick="tryJoinRoom();">Join Room</button>
        id: <input id="join-room-id" type="text" />
    </div>
    <div id="message-sending-div">
        <button id="send-message" onclick="sendMessage();">Send Message</button>
<!--         <input id="send-room-id" type="text" />
        <input id="send-user-id" type="text" /> -->
        <input id="send-message-content" type="text" />
    </div>
    <div id="current-room-div">
    	<div id="current-room-name">Add a room to join a conversation</div>
    	<div id="current-room-messages"></div>
        <button id="fetch-messages" onclick="fetchMessages();">FetchMessages</button>
    <div/>
</div>
</body>
</html>